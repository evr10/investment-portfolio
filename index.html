<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Investment Portfolio Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ===== External libraries (ORDER MATTERS) ===== -->

  <!-- CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- PDF.js (THIS FIXES pdfjsLib IS NOT DEFINED) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
  <script>
    // REQUIRED so PDF parsing works on GitHub Pages
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.min.js";
  </script>

  <!-- ===== Styling ===== -->
  <style>
    body {
      margin: 0;
      background: #0b1020;
      color: #e8ecff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    header {
      padding: 20px;
      border-bottom: 1px solid #27325f;
    }
    main {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }
    .card {
      background: #121a33;
      border: 1px solid #27325f;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
    }
    button {
      background: #0f1630;
      color: #e8ecff;
      border: 1px solid #27325f;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
    }
    button:hover {
      border-color: #7aa2ff;
    }
    input[type=file] {
      width: 100%;
      padding: 10px;
      background: #0f1630;
      color: #a7b0d6;
      border-radius: 10px;
      border: 1px dashed #27325f;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #27325f;
      font-size: 12px;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #27325f;
      font-size: 12px;
      margin-left: 10px;
    }
    .warn {
      color: #ffd27a;
      font-size: 12px;
      white-space: pre-wrap;
      margin-top: 10px;
    }
  </style>
</head>

<body>
<header>
  <h1>Investment Portfolio Overview</h1>
  <p>Upload PDF statements (holdings only) and CSV transactions. All processing stays in your browser.</p>
</header>

<main>
  <div class="card">
    <h2>Upload</h2>
    <input id="fileInput" type="file" multiple accept=".pdf,.csv" />
    <br /><br />
    <button id="processBtn">Process uploads</button>
    <button id="resetBtn">Reset</button>
    <span class="pill" id="status">Waiting…</span>
    <div class="warn" id="warnings"></div>
  </div>

  <div class="card">
    <h2>Summary</h2>
    <p>Start Value: <b id="startVal">$0</b></p>
    <p>End Value: <b id="endVal">$0</b></p>
    <p>Net Flow: <b id="flowVal">$0</b></p>
    <p>Market Growth: <b id="growthVal">$0</b></p>
  </div>

  <div class="card">
    <h2>Holdings</h2>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Start</th>
          <th>End</th>
          <th>Buys</th>
          <th>Sells</th>
          <th>Growth</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</main>

<!-- ===================== APP CODE ===================== -->
<script>
console.log("pdfjsLib loaded?", typeof pdfjsLib); // should log "object"

const $ = id => document.getElementById(id);
const fmt = n => Number.isFinite(n) ? n.toLocaleString(undefined,{style:"currency",currency:"USD"}) : "$0";

let snapshots = [];
let transactions = new Map();

/* ---------- CSV (transactions) ---------- */
function parseCsv(text) {
  const data = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
  for (const r of data) {
    const sym = (r.Symbol || r.Ticker || "").toUpperCase();
    if (!sym) continue;
    const amt = Number(String(r.Amount || r.Total || "").replace(/[$,]/g,""));
    const action = String(r.Action || "").toLowerCase();
    if (!transactions.has(sym)) transactions.set(sym, { buys:0, sells:0 });
    if (action.includes("buy")) transactions.get(sym).buys += Math.abs(amt || 0);
    if (action.includes("sell")) transactions.get(sym).sells += Math.abs(amt || 0);
  }
}

/* ---------- PDF (holdings only) ---------- */
async function parsePdf(file) {
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  const holdings = new Map();

  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const txt = await page.getTextContent();
    const lines = txt.items.map(i => i.str);

    for (const l of lines) {
      const m = l.match(/\(([A-Z]{1,6})\).*?([\d,]+\.\d{2})$/);
      if (m) {
        const sym = m[1];
        const val = Number(m[2].replace(/,/g,""));
        holdings.set(sym, (holdings.get(sym) || 0) + val);
      }
    }
  }

  snapshots.push(holdings);
}

/* ---------- Merge + Render ---------- */
function render() {
  if (snapshots.length < 2) return;

  const start = snapshots[0];
  const end = snapshots[snapshots.length - 1];

  const syms = new Set([...start.keys(), ...end.keys(), ...transactions.keys()]);
  const tbody = $("tableBody");
  tbody.innerHTML = "";

  let sTot=0, eTot=0, fTot=0, gTot=0;

  for (const sym of syms) {
    const s = start.get(sym)||0;
    const e = end.get(sym)||0;
    const t = transactions.get(sym)||{buys:0,sells:0};
    const flow = t.buys - t.sells;
    const g = e - s - flow;

    sTot+=s; eTot+=e; fTot+=flow; gTot+=g;

    tbody.innerHTML += `
      <tr>
        <td>${sym}</td>
        <td>${fmt(s)}</td>
        <td>${fmt(e)}</td>
        <td>${fmt(t.buys)}</td>
        <td>${fmt(t.sells)}</td>
        <td>${fmt(g)}</td>
      </tr>`;
  }

  $("startVal").textContent = fmt(sTot);
  $("endVal").textContent = fmt(eTot);
  $("flowVal").textContent = fmt(fTot);
  $("growthVal").textContent = fmt(gTot);
}

/* ---------- Actions ---------- */
$("processBtn").onclick = async () => {
  $("warnings").textContent = "";
  $("status").textContent = "Processing…";
  snapshots = [];
  transactions = new Map();

  for (const f of $("fileInput").files) {
    const name = f.name.toLowerCase();
    if (name.endsWith(".csv")) {
      parseCsv(await f.text());
    } else if (f.type === "application/pdf" || name.endsWith(".pdf")) {
      await parsePdf(f);
    }
  }

  render();
  $("status").textContent = `Done (PDF: ${snapshots.length}, CSV loaded)`;
};

$("resetBtn").onclick = () => {
  snapshots = [];
  transactions = new Map();
  $("tableBody").innerHTML = "";
  $("status").textContent = "Waiting…";
};
</script>
</body>
</html>
